name: Deploy Prod
run-name: "Deploy Prod: ${{ github.ref_name }}"
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
jobs:
  checkReleaseCandidate:
    runs-on: ubuntu-latest
    concurrency: deploy-prod-group
    outputs:
      isCandidate: ${{ steps.check-rc.outputs.isCandidate }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Fetch tags
        run: git fetch origin tag ${{ github.ref_name}}*
      - name: Check release candidate
        id: check-rc
        run: |
          is_rc='false'
          IFS=$'\n'
          tags=($(git tag --points-at ${GITHUB_SHA}))
          for tag in ${tags[@]}; do
            if [[ $tag == "${GITHUB_REF_NAME}-rc."* ]]; then
              is_rc='true'
            fi
          done
          echo "isCandidate=$is_rc" >> "$GITHUB_OUTPUT"
      - name: Remvoe tag
        if: steps.check-rc.outputs.isCandidate == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### This commit is not release candidate" >> $GITHUB_STEP_SUMMARY
          git push --delete origin ${{ github.ref_name }}
          echo "Remove tag ${GITHUB_REF_NAME}" >> $GITHUB_STEP_SUMMARY
          gh run cancel ${{ github.run_id }}
  deployProd:
    runs-on: ubuntu-latest
    needs: checkReleaseCandidate
    if: needs.checkReleaseCandidate.outputs.isCandidate == 'true'
    steps:
      - name: Deploy prod
        id: deploy-prod
        run: |
          echo "success"
      - name: Set deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments \
            -f ref='${{ github.ref }}' \
            -f task='abc' \
            -f auto_merge=false \
            -f payload='{ "deploy": "migratea" }' \
            -f environment='prod' \
            -f description='Deploy P: ${{ github.ref_name }}'
